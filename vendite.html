<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Vendite - Grappoli & Luppoli</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        .table-compact th, .table-compact td { padding: 0.4rem 0.6rem; font-size: 0.8rem; }
        .truncate-cell { max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100 min-h-screen">
    <script>
        const SESSION_KEY = 'app_authenticated';
        if (!localStorage.getItem(SESSION_KEY)) window.location.href = 'index.html';
    </script>

    <!-- Navbar -->
    <nav class="fixed top-0 left-0 right-0 bg-white shadow-lg z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <button onclick="window.location.href='dashboard.html'" class="flex items-center space-x-3">
                        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 p-2 rounded-lg">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                            </svg>
                        </div>
                        <span class="text-lg font-bold">Grappoli & Luppoli</span>
                    </button>
                    
                    <div class="hidden md:ml-10 md:flex md:space-x-4">
                        <a href="dashboard.html" class="px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-100">Dashboard</a>
                        <a href="fatture.html" class="px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-100">Fatture</a>
                        <a href="prodotti.html" class="px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-100">Prodotti</a>
                        <a href="vendite.html" class="px-3 py-2 rounded-md text-sm font-medium bg-green-100 text-green-700">Vendite</a>
                        <a href="margini.html" class="px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-100">Margini</a>
                        <a href="fornitori.html" class="px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-100">Fornitori</a>
                        <a href="utenti.html" class="px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-100">Utenti</a>
                    </div>
                </div>
                
                <div class="flex items-center space-x-3">
                    <button onclick="window.location.href='dashboard.html'" class="px-4 py-2 bg-gray-100 rounded-lg hover:bg-gray-200">Dashboard</button>
                    <button onclick="logout()" class="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200">Esci</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-[1600px] mx-auto px-4 pt-24 pb-8">
        <!-- Header -->
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">üìä Gestione Vendite</h1>
                <p class="text-gray-600">Import Excel, categorizzazione e Gruppi Vendita</p>
            </div>
            <div class="flex space-x-3">
                <button onclick="openImportModal()" class="px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-xl hover:from-green-600 hover:to-emerald-700 font-semibold shadow-lg flex items-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                    <span>Import Excel</span>
                </button>
                <button onclick="openGruppiVenditaModal()" class="px-4 py-3 bg-purple-100 text-purple-700 rounded-xl hover:bg-purple-200 font-medium flex items-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                    <span>Gestisci Gruppi Vendita</span>
                </button>
            </div>
        </div>

        <!-- Loading -->
        <div id="loadingProgress" class="hidden bg-white rounded-xl shadow-lg p-6 mb-8">
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium text-green-900">Caricamento...</span>
                <span id="progressText" class="text-sm text-green-700">0%</span>
            </div>
            <div class="w-full bg-green-200 rounded-full h-3">
                <div id="progressBar" class="bg-green-600 h-3 rounded-full transition-all" style="width: 0%"></div>
            </div>
            <p id="progressDetail" class="text-xs text-gray-500 mt-2"></p>
        </div>

        <!-- Statistiche -->
        <div class="grid md:grid-cols-5 gap-4 mb-6">
            <div class="bg-white rounded-xl shadow-lg p-4 border-l-4 border-green-500">
                <p class="text-xs text-gray-600">Righe Totali</p>
                <p id="statRighe" class="text-2xl font-bold text-green-600">0</p>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-4 border-l-4 border-blue-500">
                <p class="text-xs text-gray-600">Fatturato</p>
                <p id="statFatturato" class="text-2xl font-bold text-blue-600">‚Ç¨0</p>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-4 border-l-4 border-purple-500">
                <p class="text-xs text-gray-600">Pezzi Venduti</p>
                <p id="statPezzi" class="text-2xl font-bold text-purple-600">0</p>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-4 border-l-4 border-orange-500">
                <p class="text-xs text-gray-600">Categorie</p>
                <p id="statCategorie" class="text-2xl font-bold text-orange-600">0</p>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-4 border-l-4 border-indigo-500">
                <p class="text-xs text-gray-600">Gruppi Vendita</p>
                <p id="statGruppi" class="text-2xl font-bold text-indigo-600">0</p>
            </div>
        </div>

        <!-- Filtri -->
        <div class="bg-white rounded-xl shadow-lg p-4 mb-6">
            <div class="grid md:grid-cols-6 gap-3">
                <input type="text" id="filterNome" placeholder="Cerca prodotto..." class="px-3 py-2 border rounded-lg text-sm" onkeyup="applyFilters()">
                <select id="filterCategoria" class="px-3 py-2 border rounded-lg text-sm" onchange="applyFilters()">
                    <option value="">Tutte le categorie</option>
                </select>
                <select id="filterSettore" class="px-3 py-2 border rounded-lg text-sm" onchange="applyFilters()">
                    <option value="">Tutti i settori</option>
                </select>
                <select id="filterGruppo" class="px-3 py-2 border rounded-lg text-sm" onchange="applyFilters()">
                    <option value="">Tutti i gruppi</option>
                </select>
                <select id="filterMese" class="px-3 py-2 border rounded-lg text-sm" onchange="applyFilters()">
                    <option value="">Tutti i mesi</option>
                </select>
                <button onclick="clearFilters()" class="px-3 py-2 bg-gray-200 rounded-lg text-sm hover:bg-gray-300">Pulisci</button>
            </div>
        </div>

        <!-- Barra Selezione -->
        <div id="selectionBar" class="hidden bg-blue-50 rounded-xl p-4 mb-4 flex justify-between items-center">
            <span id="selectionCount" class="text-sm font-medium text-blue-900">0 righe selezionate</span>
            <div class="flex space-x-3">
                <button onclick="openBulkEditModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium flex items-center space-x-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                    <span>Modifica Massiva</span>
                </button>
                <button onclick="deleteSelected()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium flex items-center space-x-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    <span>Elimina</span>
                </button>
            </div>
        </div>

        <!-- Tabella Vendite -->
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full table-compact">
                    <thead class="bg-gradient-to-r from-green-600 to-emerald-600 text-white">
                        <tr>
                            <th class="px-2 py-3 w-10"><input type="checkbox" id="selectAll" onchange="toggleSelectAll()" class="w-4 h-4"></th>
                            <th class="px-3 py-3 text-left text-xs">Mese</th>
                            <th class="px-3 py-3 text-left text-xs">Nome Prodotto</th>
                            <th class="px-3 py-3 text-left text-xs">Categoria</th>
                            <th class="px-3 py-3 text-left text-xs">Settore</th>
                            <th class="px-3 py-3 text-left text-xs">Gruppo Vendita</th>
                            <th class="px-3 py-3 text-right text-xs">Prezzo</th>
                            <th class="px-3 py-3 text-right text-xs">Pezzi</th>
                            <th class="px-3 py-3 text-right text-xs">Fatturato</th>
                            <th class="px-3 py-3 text-center text-xs">Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="venditeTableBody" class="divide-y divide-gray-100"></tbody>
                </table>
            </div>
            
            <!-- Paginazione -->
            <div class="px-6 py-4 bg-gray-50 flex justify-between items-center">
                <div class="text-sm text-gray-600">
                    Mostrando <span id="showingFrom">0</span>-<span id="showingTo">0</span> di <span id="showingTotal">0</span>
                </div>
                <div class="flex space-x-2">
                    <button onclick="prevPage()" id="btnPrev" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50" disabled>‚Üê Prec</button>
                    <span id="pageInfo" class="px-3 py-1">Pagina 1</span>
                    <button onclick="nextPage()" id="btnNext" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50">Succ ‚Üí</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Import Excel -->
    <div id="importModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full p-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">üì• Import Vendite da Excel</h2>
                <button onclick="closeImportModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <div class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-green-500 cursor-pointer transition-colors" onclick="document.getElementById('excelInput').click()">
                <input type="file" id="excelInput" accept=".xlsx,.xls" class="hidden" onchange="handleExcelUpload(event)">
                <svg class="w-16 h-16 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                <p class="text-lg font-bold mb-2">Carica file VENDITE.xlsx</p>
                <p class="text-sm text-gray-600">Trascina qui o clicca per selezionare</p>
            </div>
            
            <div id="importProgress" class="hidden mt-6">
                <div class="flex justify-between mb-2">
                    <span class="text-sm font-medium">Importazione in corso...</span>
                    <span id="importProgressText" class="text-sm">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3">
                    <div id="importProgressBar" class="bg-green-600 h-3 rounded-full transition-all" style="width: 0%"></div>
                </div>
            </div>
            
            <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                <p class="text-sm text-blue-800"><strong>Formato atteso:</strong></p>
                <p class="text-xs text-blue-700 mt-1">Mese, SKU ORIGINE, NOME, SKU CONVERSIONE, ID SETTORE, NOME UNIVOCO, Categoria, Prezzo, Prezzo medio, Pezzi Venduti, FATTURATO</p>
            </div>
        </div>
    </div>

    <!-- Modal Modifica Singola Vendita -->
    <div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full p-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">‚úèÔ∏è Modifica Vendita</h2>
                <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <form onsubmit="saveVendita(event)" class="space-y-6">
                <input type="hidden" id="editId">
                
                <!-- Info Prodotto (read-only) -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <p class="text-xs text-gray-500 mb-1">Prodotto</p>
                            <p id="editNomeProdotto" class="font-bold text-lg"></p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 mb-1">Mese</p>
                            <p id="editMese" class="font-medium"></p>
                        </div>
                    </div>
                </div>
                
                <!-- Sezione Categorizzazione -->
                <div class="bg-purple-50 rounded-lg p-4">
                    <h3 class="font-bold text-purple-900 mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path></svg>
                        Categorizzazione
                    </h3>
                    <div class="grid md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-purple-800 mb-2">Categoria</label>
                            <div class="flex space-x-2">
                                <select id="editCategoria" class="flex-1 px-4 py-2 border-2 border-purple-200 rounded-lg focus:ring-2 focus:ring-purple-500">
                                    <option value="">Seleziona categoria</option>
                                </select>
                                <button type="button" onclick="showNewCategoriaInput()" class="px-3 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200" title="Nuova categoria">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                                </button>
                            </div>
                            <input type="text" id="newCategoriaInput" class="hidden mt-2 w-full px-3 py-2 border rounded-lg text-sm" placeholder="Nuova categoria...">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-purple-800 mb-2">Settore</label>
                            <div class="flex space-x-2">
                                <select id="editSettore" class="flex-1 px-4 py-2 border-2 border-purple-200 rounded-lg focus:ring-2 focus:ring-purple-500">
                                    <option value="">Seleziona settore</option>
                                </select>
                                <button type="button" onclick="showNewSettoreInput()" class="px-3 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200" title="Nuovo settore">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                                </button>
                            </div>
                            <input type="text" id="newSettoreInput" class="hidden mt-2 w-full px-3 py-2 border rounded-lg text-sm" placeholder="Nuovo settore...">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-purple-800 mb-2">Gruppo Vendita *</label>
                            <select id="editGruppoVendita" class="w-full px-4 py-2 border-2 border-purple-200 rounded-lg focus:ring-2 focus:ring-purple-500" required>
                                <option value="">Seleziona gruppo</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Sezione Valori Economici -->
                <div class="bg-green-50 rounded-lg p-4">
                    <h3 class="font-bold text-green-900 mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Valori Economici
                    </h3>
                    <div class="grid md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-green-800 mb-2">Prezzo Unitario ‚Ç¨</label>
                            <input type="number" step="0.01" id="editPrezzo" class="w-full px-4 py-2 border-2 border-green-200 rounded-lg focus:ring-2 focus:ring-green-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-green-800 mb-2">Pezzi Venduti</label>
                            <input type="number" step="0.01" id="editPezzi" class="w-full px-4 py-2 border-2 border-green-200 rounded-lg focus:ring-2 focus:ring-green-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-green-800 mb-2">Fatturato ‚Ç¨</label>
                            <input type="number" step="0.01" id="editFatturato" class="w-full px-4 py-2 border-2 border-green-200 rounded-lg focus:ring-2 focus:ring-green-500">
                        </div>
                    </div>
                </div>
                
                <!-- Pulsanti -->
                <div class="flex space-x-4 pt-4 border-t">
                    <button type="submit" class="flex-1 px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg hover:from-green-600 hover:to-emerald-700 font-medium shadow-lg flex items-center justify-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                        <span>Salva Modifiche</span>
                    </button>
                    <button type="button" onclick="closeEditModal()" class="px-6 py-3 bg-gray-200 rounded-lg hover:bg-gray-300 font-medium">Annulla</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Modifica Massiva -->
    <div id="bulkEditModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">‚úèÔ∏è Modifica Massiva</h2>
                <button onclick="closeBulkEditModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <div class="bg-blue-50 rounded-lg p-4 mb-6">
                <p class="text-sm text-blue-800"><strong id="bulkCount">0</strong> righe selezionate</p>
                <p class="text-xs text-blue-600 mt-1">Lascia vuoto il campo che non vuoi modificare</p>
            </div>
            
            <form onsubmit="saveBulkEdit(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Categoria</label>
                    <select id="bulkCategoria" class="w-full px-4 py-2 border rounded-lg">
                        <option value="">-- Non modificare --</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Settore</label>
                    <select id="bulkSettore" class="w-full px-4 py-2 border rounded-lg">
                        <option value="">-- Non modificare --</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Gruppo Vendita</label>
                    <select id="bulkGruppoVendita" class="w-full px-4 py-2 border rounded-lg">
                        <option value="">-- Non modificare --</option>
                    </select>
                </div>
                
                <div class="flex space-x-4 pt-4">
                    <button type="submit" class="flex-1 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">‚úÖ Applica a tutti</button>
                    <button type="button" onclick="closeBulkEditModal()" class="px-6 py-3 bg-gray-200 rounded-lg hover:bg-gray-300">Annulla</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Gestione Gruppi Vendita -->
    <div id="gruppiModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full p-8 max-h-[90vh] overflow-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">üì¶ Gestione Gruppi Vendita</h2>
                <button onclick="closeGruppiVenditaModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <!-- Form Nuovo Gruppo -->
            <div class="bg-green-50 rounded-lg p-4 mb-6">
                <h3 class="font-bold text-green-800 mb-3">‚ûï Nuovo Gruppo Vendita</h3>
                <div class="grid md:grid-cols-4 gap-3">
                    <div class="md:col-span-2">
                        <input type="text" id="nuovoGruppoNome" placeholder="Nome gruppo" class="w-full px-3 py-2 border rounded-lg text-sm">
                    </div>
                    <div>
                        <input type="color" id="nuovoGruppoColore" value="#10B981" class="w-full h-10 border rounded-lg">
                    </div>
                    <div>
                        <button type="button" onclick="createGruppoVendita()" class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium">Crea</button>
                    </div>
                </div>
            </div>
            
            <!-- Lista Gruppi -->
            <div class="border rounded-lg overflow-hidden">
                <table class="w-full">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-semibold">Colore</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold">Nome</th>
                            <th class="px-4 py-3 text-center text-sm font-semibold">Prodotti</th>
                            <th class="px-4 py-3 text-center text-sm font-semibold">Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="gruppiTableBody" class="divide-y"></tbody>
                </table>
            </div>
            
            <!-- Setup Automatico -->
            <div class="mt-6 bg-purple-50 rounded-lg p-4">
                <h3 class="font-bold text-purple-800 mb-2">üîß Setup Automatico</h3>
                <p class="text-sm text-purple-700 mb-3">Crea automaticamente i 6 gruppi vendita standard: Vino, Birra, Cibo, Alcolici, Bevande, Miscellaneo</p>
                <button onclick="setupGruppiDefault()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-medium">Crea Gruppi Standard</button>
            </div>
            
            <!-- Mappatura Automatica -->
            <div class="mt-4 bg-blue-50 rounded-lg p-4">
                <h3 class="font-bold text-blue-800 mb-2">üîÑ Mappatura Automatica</h3>
                <p class="text-sm text-blue-700 mb-3">Assegna automaticamente il Gruppo Vendita a tutte le vendite in base alla Categoria</p>
                <button onclick="autoMapGruppi()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">Esegui Mappatura</button>
            </div>
        </div>
    </div>

    <!-- Modal Conferma Eliminazione -->
    <div id="deleteModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8">
            <div class="text-center mb-6">
                <div class="bg-red-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                </div>
                <h2 class="text-2xl font-bold text-gray-900 mb-2">Conferma Eliminazione</h2>
                <p id="deleteMessage" class="text-gray-600"></p>
            </div>
            <div class="flex space-x-4">
                <button onclick="closeDeleteModal()" class="flex-1 px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium">Annulla</button>
                <button onclick="confirmDelete()" class="flex-1 px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium">Elimina</button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://fqnzoxttbzzlgjxefelx.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZxbnpveHR0Ynp6bGdqeGVmZWx4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjczNzE4NTksImV4cCI6MjA4Mjk0Nzg1OX0.PLsZsBkac_Pjd8irfOXSwGlM5mg7B6X-5HRSQOfaFnk';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const BATCH_SIZE = 500;
        const PAGE_SIZE = 100;

        function logout() {
            localStorage.removeItem('app_authenticated');
            window.location.href = 'index.html';
        }

        // ===== STATO GLOBALE =====
        let allVendite = [];
        let filteredVendite = [];
        let allGruppiVendita = [];
        let allCategorie = [];
        let allSettori = [];
        let selectedIds = new Set();
        let currentPage = 1;
        let deleteAction = null;

        // ===== GRUPPI VENDITA DEFAULT =====
        const GRUPPI_DEFAULT = [
            { nome: 'Vino', colore: '#7C3AED', ordine: 1 },
            { nome: 'Birra', colore: '#F59E0B', ordine: 2 },
            { nome: 'Cibo', colore: '#EF4444', ordine: 3 },
            { nome: 'Alcolici', colore: '#3B82F6', ordine: 4 },
            { nome: 'Bevande', colore: '#10B981', ordine: 5 },
            { nome: 'Miscellaneo', colore: '#6B7280', ordine: 6 }
        ];

        // Mappatura automatica Categoria ‚Üí Gruppo Vendita
        const MAPPING_CATEGORIA_GRUPPO = {
            'Birra': 'Birra',
            'Menu cibo': 'Cibo',
            'Vino bottiglia mescita': 'Vino',
            'Vino al calice': 'Vino',
            'Drink': 'Alcolici',
            'Menu fisso': 'Cibo',
            'Vino  bottiglia asporto': 'Vino',
            'Vino bottiglia asporto': 'Vino',
            'Bibite': 'Bevande',
            'Vetrina': 'Miscellaneo'
        };

        // ===== CARICAMENTO DATI =====
        async function loadData() {
            try {
                showLoading(true, 0, 'Inizializzazione...');
                
                // Carica gruppi vendita
                showLoading(true, 10, 'Caricamento gruppi vendita...');
                await loadGruppiVendita();
                
                // Carica vendite
                showLoading(true, 20, 'Conteggio vendite...');
                const { count } = await supabaseClient.from('vendite').select('*', { count: 'exact', head: true });
                
                if (!count || count === 0) {
                    showLoading(false);
                    renderTable([]);
                    updateStats();
                    return;
                }
                
                allVendite = [];
                const numBatches = Math.ceil(count / BATCH_SIZE);
                
                for (let i = 0; i < numBatches; i++) {
                    showLoading(true, 20 + (i / numBatches * 70), `Caricamento ${allVendite.length}/${count}...`);
                    
                    const { data, error } = await supabaseClient
                        .from('vendite')
                        .select('*, gruppo_vendita:gruppo_vendita_id(id, nome, colore)')
                        .order('mese', { ascending: false })
                        .range(i * BATCH_SIZE, (i + 1) * BATCH_SIZE - 1);
                    
                    if (error) throw error;
                    if (data) allVendite = [...allVendite, ...data];
                }
                
                showLoading(true, 95, 'Elaborazione...');
                
                // Estrai categorie e settori unici
                allCategorie = [...new Set(allVendite.map(v => v.categoria).filter(Boolean))].sort();
                allSettori = [...new Set(allVendite.map(v => v.id_settore).filter(Boolean))].sort();
                
                populateFilters();
                applyFilters();
                updateStats();
                
                showLoading(false);
                
            } catch (err) {
                console.error('Errore caricamento:', err);
                showLoading(false);
                alert('‚ùå Errore: ' + err.message);
            }
        }

        async function loadGruppiVendita() {
            try {
                const { data, error } = await supabaseClient
                    .from('gruppo_vendita')
                    .select('*')
                    .order('ordine', { ascending: true });
                
                if (error) {
                    console.log('Tabella gruppo_vendita non trovata, verr√† creata al primo setup');
                    allGruppiVendita = [];
                    return;
                }
                
                allGruppiVendita = data || [];
                updateGruppiSelects();
                
            } catch (err) {
                console.error('Errore caricamento gruppi:', err);
                allGruppiVendita = [];
            }
        }

        function showLoading(show, percent = 0, detail = '') {
            const el = document.getElementById('loadingProgress');
            if (show) {
                el.classList.remove('hidden');
                document.getElementById('progressBar').style.width = percent + '%';
                document.getElementById('progressText').textContent = Math.round(percent) + '%';
                document.getElementById('progressDetail').textContent = detail;
            } else {
                el.classList.add('hidden');
            }
        }

        // ===== FILTRI =====
        function populateFilters() {
            const mesi = [...new Set(allVendite.map(v => v.mese).filter(Boolean))].sort().reverse();
            
            // Categorie
            document.getElementById('filterCategoria').innerHTML = '<option value="">Tutte le categorie</option>' +
                allCategorie.map(c => `<option value="${c}">${c}</option>`).join('');
            
            // Settori
            document.getElementById('filterSettore').innerHTML = '<option value="">Tutti i settori</option>' +
                allSettori.map(s => `<option value="${s}">${s}</option>`).join('');
            
            // Mesi
            document.getElementById('filterMese').innerHTML = '<option value="">Tutti i mesi</option>' +
                mesi.map(m => `<option value="${m}">${m}</option>`).join('');
            
            updateGruppiSelects();
            updateEditSelects();
            updateBulkSelects();
        }

        function updateGruppiSelects() {
            const options = '<option value="">Tutti i gruppi</option>' +
                allGruppiVendita.map(g => `<option value="${g.id}">${g.nome}</option>`).join('');
            
            document.getElementById('filterGruppo').innerHTML = options;
        }

        function updateEditSelects() {
            // Categorie nel modal edit
            const catOptions = '<option value="">Seleziona categoria</option>' +
                allCategorie.map(c => `<option value="${c}">${c}</option>`).join('');
            document.getElementById('editCategoria').innerHTML = catOptions;
            
            // Settori nel modal edit
            const setOptions = '<option value="">Seleziona settore</option>' +
                allSettori.map(s => `<option value="${s}">${s}</option>`).join('');
            document.getElementById('editSettore').innerHTML = setOptions;
            
            // Gruppi nel modal edit
            const grpOptions = '<option value="">Seleziona gruppo</option>' +
                allGruppiVendita.map(g => `<option value="${g.id}">${g.nome}</option>`).join('');
            document.getElementById('editGruppoVendita').innerHTML = grpOptions;
        }

        function updateBulkSelects() {
            // Categorie bulk
            const catOptions = '<option value="">-- Non modificare --</option>' +
                allCategorie.map(c => `<option value="${c}">${c}</option>`).join('');
            document.getElementById('bulkCategoria').innerHTML = catOptions;
            
            // Settori bulk
            const setOptions = '<option value="">-- Non modificare --</option>' +
                allSettori.map(s => `<option value="${s}">${s}</option>`).join('');
            document.getElementById('bulkSettore').innerHTML = setOptions;
            
            // Gruppi bulk
            const grpOptions = '<option value="">-- Non modificare --</option>' +
                allGruppiVendita.map(g => `<option value="${g.id}">${g.nome}</option>`).join('');
            document.getElementById('bulkGruppoVendita').innerHTML = grpOptions;
        }

        function applyFilters() {
            const nome = document.getElementById('filterNome').value.toLowerCase();
            const categoria = document.getElementById('filterCategoria').value;
            const settore = document.getElementById('filterSettore').value;
            const gruppo = document.getElementById('filterGruppo').value;
            const mese = document.getElementById('filterMese').value;
            
            filteredVendite = allVendite.filter(v => {
                if (nome && !v.nome?.toLowerCase().includes(nome) && !v.nome_univoco?.toLowerCase().includes(nome)) return false;
                if (categoria && v.categoria !== categoria) return false;
                if (settore && v.id_settore !== settore) return false;
                if (gruppo && v.gruppo_vendita_id != gruppo) return false;
                if (mese && v.mese !== mese) return false;
                return true;
            });
            
            currentPage = 1;
            renderTable(filteredVendite);
            updateStats();
        }

        function clearFilters() {
            document.getElementById('filterNome').value = '';
            document.getElementById('filterCategoria').value = '';
            document.getElementById('filterSettore').value = '';
            document.getElementById('filterGruppo').value = '';
            document.getElementById('filterMese').value = '';
            applyFilters();
        }

        // ===== STATISTICHE =====
        function updateStats() {
            const data = filteredVendite.length > 0 ? filteredVendite : allVendite;
            
            document.getElementById('statRighe').textContent = data.length.toLocaleString('it-IT');
            document.getElementById('statFatturato').textContent = '‚Ç¨' + data.reduce((s, v) => s + (parseFloat(v.fatturato) || 0), 0).toLocaleString('it-IT', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            document.getElementById('statPezzi').textContent = data.reduce((s, v) => s + (parseFloat(v.pezzi_venduti) || 0), 0).toLocaleString('it-IT', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            document.getElementById('statCategorie').textContent = new Set(data.map(v => v.categoria).filter(Boolean)).size;
            document.getElementById('statGruppi').textContent = allGruppiVendita.length;
        }

        // ===== TABELLA =====
        function renderTable(data) {
            const tbody = document.getElementById('venditeTableBody');
            const start = (currentPage - 1) * PAGE_SIZE;
            const end = start + PAGE_SIZE;
            const pageData = data.slice(start, end);
            
            if (pageData.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="10" class="px-6 py-12 text-center text-gray-400">
                        <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                        </svg>
                        <p class="text-lg font-medium">Nessun dato</p>
                        <p class="text-sm mt-1">Importa un file Excel per iniziare</p>
                    </td></tr>
                `;
            } else {
                tbody.innerHTML = pageData.map(v => {
                    const gruppo = v.gruppo_vendita || {};
                    const gruppoNome = gruppo.nome || '-';
                    const gruppoColore = gruppo.colore || '#6B7280';
                    
                    return `
                        <tr class="hover:bg-gray-50 ${selectedIds.has(v.id) ? 'bg-blue-50' : ''}">
                            <td class="px-2 py-2 text-center">
                                <input type="checkbox" ${selectedIds.has(v.id) ? 'checked' : ''} onchange="toggleSelect('${v.id}')" class="w-4 h-4">
                            </td>
                            <td class="px-3 py-2 text-xs">${v.mese || '-'}</td>
                            <td class="px-3 py-2 truncate-cell" title="${v.nome || v.nome_univoco || ''}">${v.nome || v.nome_univoco || '-'}</td>
                            <td class="px-3 py-2 text-xs">${v.categoria || '-'}</td>
                            <td class="px-3 py-2 text-xs">${v.id_settore || '-'}</td>
                            <td class="px-3 py-2">
                                <span class="inline-flex px-2 py-1 rounded-full text-xs font-medium" style="background-color: ${gruppoColore}20; color: ${gruppoColore}; border: 1px solid ${gruppoColore}40">
                                    ${gruppoNome}
                                </span>
                            </td>
                            <td class="px-3 py-2 text-right text-xs">‚Ç¨${(parseFloat(v.prezzo) || 0).toFixed(2)}</td>
                            <td class="px-3 py-2 text-right text-xs">${(parseFloat(v.pezzi_venduti) || 0).toLocaleString('it-IT')}</td>
                            <td class="px-3 py-2 text-right text-xs font-bold text-green-600">‚Ç¨${(parseFloat(v.fatturato) || 0).toFixed(2)}</td>
                            <td class="px-3 py-2 text-center">
                                <button onclick="editVendita('${v.id}')" class="text-blue-600 hover:text-blue-800 p-1" title="Modifica">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
            
            // Aggiorna paginazione
            const totalPages = Math.ceil(data.length / PAGE_SIZE);
            document.getElementById('showingFrom').textContent = data.length > 0 ? start + 1 : 0;
            document.getElementById('showingTo').textContent = Math.min(end, data.length);
            document.getElementById('showingTotal').textContent = data.length;
            document.getElementById('pageInfo').textContent = `Pagina ${currentPage} di ${totalPages || 1}`;
            document.getElementById('btnPrev').disabled = currentPage <= 1;
            document.getElementById('btnNext').disabled = currentPage >= totalPages;
            
            updateSelectionBar();
        }

        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                renderTable(filteredVendite);
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(filteredVendite.length / PAGE_SIZE);
            if (currentPage < totalPages) {
                currentPage++;
                renderTable(filteredVendite);
            }
        }

        // ===== SELEZIONE =====
        function toggleSelect(id) {
            if (selectedIds.has(id)) {
                selectedIds.delete(id);
            } else {
                selectedIds.add(id);
            }
            renderTable(filteredVendite);
        }

        function toggleSelectAll() {
            const checkbox = document.getElementById('selectAll');
            const start = (currentPage - 1) * PAGE_SIZE;
            const end = start + PAGE_SIZE;
            const pageData = filteredVendite.slice(start, end);
            
            if (checkbox.checked) {
                pageData.forEach(v => selectedIds.add(v.id));
            } else {
                pageData.forEach(v => selectedIds.delete(v.id));
            }
            renderTable(filteredVendite);
        }

        function updateSelectionBar() {
            const bar = document.getElementById('selectionBar');
            if (selectedIds.size > 0) {
                bar.classList.remove('hidden');
                document.getElementById('selectionCount').textContent = `${selectedIds.size} righe selezionate`;
            } else {
                bar.classList.add('hidden');
            }
        }

        // ===== MODAL IMPORT =====
        function openImportModal() {
            document.getElementById('importModal').classList.remove('hidden');
        }

        function closeImportModal() {
            document.getElementById('importModal').classList.add('hidden');
            document.getElementById('importProgress').classList.add('hidden');
        }

        // ===== MODAL EDIT SINGOLO =====
        function editVendita(id) {
            const v = allVendite.find(x => x.id === id);
            if (!v) return;
            
            document.getElementById('editId').value = v.id;
            document.getElementById('editNomeProdotto').textContent = v.nome || v.nome_univoco || '-';
            document.getElementById('editMese').textContent = v.mese || '-';
            document.getElementById('editCategoria').value = v.categoria || '';
            document.getElementById('editSettore').value = v.id_settore || '';
            document.getElementById('editGruppoVendita').value = v.gruppo_vendita_id || '';
            document.getElementById('editPrezzo').value = v.prezzo || '';
            document.getElementById('editPezzi').value = v.pezzi_venduti || '';
            document.getElementById('editFatturato').value = v.fatturato || '';
            
            // Nascondi input nuovi
            document.getElementById('newCategoriaInput').classList.add('hidden');
            document.getElementById('newSettoreInput').classList.add('hidden');
            
            document.getElementById('editModal').classList.remove('hidden');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
        }

        function showNewCategoriaInput() {
            const input = document.getElementById('newCategoriaInput');
            input.classList.toggle('hidden');
            if (!input.classList.contains('hidden')) input.focus();
        }

        function showNewSettoreInput() {
            const input = document.getElementById('newSettoreInput');
            input.classList.toggle('hidden');
            if (!input.classList.contains('hidden')) input.focus();
        }

        async function saveVendita(e) {
            e.preventDefault();
            
            const id = document.getElementById('editId').value;
            
            // Check per nuova categoria
            let categoria = document.getElementById('editCategoria').value;
            const newCat = document.getElementById('newCategoriaInput').value.trim();
            if (newCat) {
                categoria = newCat;
                if (!allCategorie.includes(newCat)) {
                    allCategorie.push(newCat);
                    allCategorie.sort();
                }
            }
            
            // Check per nuovo settore
            let settore = document.getElementById('editSettore').value;
            const newSet = document.getElementById('newSettoreInput').value.trim();
            if (newSet) {
                settore = newSet;
                if (!allSettori.includes(newSet)) {
                    allSettori.push(newSet);
                    allSettori.sort();
                }
            }
            
            const gruppoVenditaId = document.getElementById('editGruppoVendita').value || null;
            
            const updateData = {
                categoria: categoria || null,
                id_settore: settore || null,
                gruppo_vendita_id: gruppoVenditaId,
                prezzo: parseFloat(document.getElementById('editPrezzo').value) || null,
                pezzi_venduti: parseFloat(document.getElementById('editPezzi').value) || null,
                fatturato: parseFloat(document.getElementById('editFatturato').value) || null
            };
            
            try {
                const { error } = await supabaseClient
                    .from('vendite')
                    .update(updateData)
                    .eq('id', id);
                
                if (error) throw error;
                
                closeEditModal();
                
                // Aggiorna localmente
                const idx = allVendite.findIndex(v => v.id === id);
                if (idx >= 0) {
                    allVendite[idx] = { ...allVendite[idx], ...updateData };
                    if (gruppoVenditaId) {
                        allVendite[idx].gruppo_vendita = allGruppiVendita.find(g => g.id == gruppoVenditaId) || null;
                    } else {
                        allVendite[idx].gruppo_vendita = null;
                    }
                }
                
                populateFilters();
                applyFilters();
                
                alert('‚úÖ Vendita aggiornata!');
                
            } catch (err) {
                console.error('Errore salvataggio:', err);
                alert('‚ùå Errore: ' + err.message);
            }
        }

        // ===== MODAL BULK EDIT =====
        function openBulkEditModal() {
            if (selectedIds.size === 0) {
                alert('Seleziona almeno una riga');
                return;
            }
            document.getElementById('bulkCount').textContent = selectedIds.size;
            
            // Reset selects
            document.getElementById('bulkCategoria').value = '';
            document.getElementById('bulkSettore').value = '';
            document.getElementById('bulkGruppoVendita').value = '';
            
            document.getElementById('bulkEditModal').classList.remove('hidden');
        }

        function closeBulkEditModal() {
            document.getElementById('bulkEditModal').classList.add('hidden');
        }

        async function saveBulkEdit(e) {
            e.preventDefault();
            
            const categoria = document.getElementById('bulkCategoria').value;
            const settore = document.getElementById('bulkSettore').value;
            const gruppoId = document.getElementById('bulkGruppoVendita').value;
            
            if (!categoria && !settore && !gruppoId) {
                alert('Seleziona almeno un campo da modificare');
                return;
            }
            
            const ids = Array.from(selectedIds);
            
            try {
                closeBulkEditModal();
                showLoading(true, 0, 'Aggiornamento in corso...');
                
                // Prepara dati update
                const updateData = {};
                if (categoria) updateData.categoria = categoria;
                if (settore) updateData.id_settore = settore;
                if (gruppoId) updateData.gruppo_vendita_id = gruppoId;
                
                const BATCH_UPDATE = 100;
                for (let i = 0; i < ids.length; i += BATCH_UPDATE) {
                    const batch = ids.slice(i, i + BATCH_UPDATE);
                    
                    const { error } = await supabaseClient
                        .from('vendite')
                        .update(updateData)
                        .in('id', batch);
                    
                    if (error) throw error;
                    
                    showLoading(true, (i / ids.length) * 100, `Aggiornamento ${i}/${ids.length}...`);
                }
                
                selectedIds.clear();
                await loadData();
                alert(`‚úÖ ${ids.length} righe aggiornate!`);
                
            } catch (err) {
                console.error('Errore bulk edit:', err);
                showLoading(false);
                alert('‚ùå Errore: ' + err.message);
            }
        }

        // ===== GRUPPI VENDITA =====
        function openGruppiVenditaModal() {
            renderGruppiTable();
            document.getElementById('gruppiModal').classList.remove('hidden');
        }

        function closeGruppiVenditaModal() {
            document.getElementById('gruppiModal').classList.add('hidden');
        }

        function renderGruppiTable() {
            const tbody = document.getElementById('gruppiTableBody');
            
            if (allGruppiVendita.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="4" class="px-4 py-8 text-center text-gray-400">
                        Nessun gruppo vendita. Usa il setup automatico o creane uno nuovo.
                    </td></tr>
                `;
                return;
            }
            
            // Conta prodotti per gruppo
            const countPerGruppo = {};
            allVendite.forEach(v => {
                const gid = v.gruppo_vendita_id;
                if (gid) countPerGruppo[gid] = (countPerGruppo[gid] || 0) + 1;
            });
            
            tbody.innerHTML = allGruppiVendita.map(g => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3">
                        <div class="w-6 h-6 rounded-full" style="background-color: ${g.colore}"></div>
                    </td>
                    <td class="px-4 py-3 font-medium">${g.nome}</td>
                    <td class="px-4 py-3 text-center">${countPerGruppo[g.id] || 0}</td>
                    <td class="px-4 py-3 text-center">
                        <button onclick="deleteGruppoVendita('${g.id}', '${g.nome}')" class="text-red-600 hover:text-red-800 p-1" title="Elimina">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        async function createGruppoVendita() {
            const nome = document.getElementById('nuovoGruppoNome').value.trim();
            const colore = document.getElementById('nuovoGruppoColore').value;
            
            if (!nome) {
                alert('Inserisci un nome');
                return;
            }
            
            try {
                const { error } = await supabaseClient
                    .from('gruppo_vendita')
                    .insert([{ nome, colore, ordine: allGruppiVendita.length + 1 }]);
                
                if (error) throw error;
                
                document.getElementById('nuovoGruppoNome').value = '';
                await loadGruppiVendita();
                renderGruppiTable();
                updateEditSelects();
                updateBulkSelects();
                
            } catch (err) {
                console.error('Errore creazione:', err);
                alert('‚ùå Errore: ' + err.message);
            }
        }

        async function deleteGruppoVendita(id, nome) {
            if (!confirm(`Eliminare il gruppo "${nome}"?`)) return;
            
            try {
                // Prima rimuovi il riferimento dalle vendite
                await supabaseClient
                    .from('vendite')
                    .update({ gruppo_vendita_id: null })
                    .eq('gruppo_vendita_id', id);
                
                // Poi elimina il gruppo
                const { error } = await supabaseClient
                    .from('gruppo_vendita')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                await loadGruppiVendita();
                renderGruppiTable();
                updateEditSelects();
                updateBulkSelects();
                
            } catch (err) {
                console.error('Errore eliminazione:', err);
                alert('‚ùå Errore: ' + err.message);
            }
        }

        async function setupGruppiDefault() {
            try {
                const existingNames = allGruppiVendita.map(g => g.nome);
                const toInsert = GRUPPI_DEFAULT.filter(g => !existingNames.includes(g.nome));
                
                if (toInsert.length === 0) {
                    alert('Tutti i gruppi standard sono gi√† presenti!');
                    return;
                }
                
                const { error } = await supabaseClient
                    .from('gruppo_vendita')
                    .insert(toInsert);
                
                if (error) throw error;
                
                await loadGruppiVendita();
                renderGruppiTable();
                updateEditSelects();
                updateBulkSelects();
                alert(`‚úÖ Creati ${toInsert.length} gruppi: ${toInsert.map(g => g.nome).join(', ')}`);
                
            } catch (err) {
                console.error('Errore setup:', err);
                alert('‚ùå Errore: ' + err.message);
            }
        }

        async function autoMapGruppi() {
            if (allGruppiVendita.length === 0) {
                alert('Prima crea i gruppi vendita standard');
                return;
            }
            
            const confermato = confirm(
                'Questa operazione assegner√† automaticamente il Gruppo Vendita a tutte le vendite basandosi sulla Categoria.\n\n' +
                'Mappatura:\n' +
                '‚Ä¢ Birra ‚Üí Birra\n' +
                '‚Ä¢ Menu cibo, Menu fisso ‚Üí Cibo\n' +
                '‚Ä¢ Vino bottiglia/calice/asporto ‚Üí Vino\n' +
                '‚Ä¢ Drink ‚Üí Alcolici\n' +
                '‚Ä¢ Bibite ‚Üí Bevande\n' +
                '‚Ä¢ Vetrina ‚Üí Miscellaneo\n\n' +
                'Continuare?'
            );
            
            if (!confermato) return;
            
            try {
                closeGruppiVenditaModal();
                showLoading(true, 0, 'Mappatura automatica...');
                
                // Crea mappa nome -> id
                const gruppoMap = {};
                allGruppiVendita.forEach(g => gruppoMap[g.nome] = g.id);
                
                let updated = 0;
                const BATCH_UPDATE = 100;
                
                // Per ogni categoria, aggiorna le vendite
                for (const [categoria, gruppoNome] of Object.entries(MAPPING_CATEGORIA_GRUPPO)) {
                    const gruppoId = gruppoMap[gruppoNome];
                    if (!gruppoId) continue;
                    
                    // Trova vendite con questa categoria
                    const venditeConCategoria = allVendite.filter(v => v.categoria === categoria && v.gruppo_vendita_id != gruppoId);
                    
                    if (venditeConCategoria.length === 0) continue;
                    
                    const ids = venditeConCategoria.map(v => v.id);
                    
                    for (let i = 0; i < ids.length; i += BATCH_UPDATE) {
                        const batch = ids.slice(i, i + BATCH_UPDATE);
                        
                        await supabaseClient
                            .from('vendite')
                            .update({ gruppo_vendita_id: gruppoId })
                            .in('id', batch);
                        
                        updated += batch.length;
                    }
                    
                    showLoading(true, 50 + (updated / allVendite.length * 50), `Aggiornate ${updated} vendite...`);
                }
                
                await loadData();
                alert(`‚úÖ Mappatura completata! ${updated} vendite aggiornate.`);
                
            } catch (err) {
                console.error('Errore mappatura:', err);
                showLoading(false);
                alert('‚ùå Errore: ' + err.message);
            }
        }

        // ===== ELIMINAZIONE =====
        function deleteSelected() {
            if (selectedIds.size === 0) return;
            
            document.getElementById('deleteMessage').textContent = `Eliminare ${selectedIds.size} righe selezionate?`;
            deleteAction = { ids: Array.from(selectedIds) };
            document.getElementById('deleteModal').classList.remove('hidden');
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.add('hidden');
            deleteAction = null;
        }

        async function confirmDelete() {
            if (!deleteAction) return;
            
            const ids = deleteAction.ids;
            closeDeleteModal();
            
            try {
                showLoading(true, 0, 'Eliminazione...');
                
                const BATCH_DELETE = 100;
                for (let i = 0; i < ids.length; i += BATCH_DELETE) {
                    const batch = ids.slice(i, i + BATCH_DELETE);
                    
                    const { error } = await supabaseClient
                        .from('vendite')
                        .delete()
                        .in('id', batch);
                    
                    if (error) throw error;
                    
                    showLoading(true, (i / ids.length) * 100, `Eliminazione ${i}/${ids.length}...`);
                }
                
                selectedIds.clear();
                await loadData();
                alert(`‚úÖ ${ids.length} righe eliminate!`);
                
            } catch (err) {
                console.error('Errore eliminazione:', err);
                showLoading(false);
                alert('‚ùå Errore: ' + err.message);
            }
        }

        // ===== IMPORT EXCEL =====
        async function handleExcelUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                document.getElementById('importProgress').classList.remove('hidden');
                updateImportProgress(5, 'Lettura file...');
                
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data, { type: 'array' });
                
                // Cerca il foglio corretto
                let sheetName = workbook.SheetNames.find(n => n.toLowerCase().includes('prodotti') || n.toLowerCase().includes('db'));
                if (!sheetName) sheetName = workbook.SheetNames[0];
                
                const sheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(sheet, { defval: null });
                
                if (jsonData.length === 0) {
                    alert('Il file √® vuoto');
                    return;
                }
                
                updateImportProgress(15, `Trovate ${jsonData.length} righe...`);
                
                // Mapping colonne
                const getCol = (row, ...names) => {
                    for (const name of names) {
                        for (const key of Object.keys(row)) {
                            if (key.toLowerCase().trim() === name.toLowerCase().trim()) {
                                return row[key];
                            }
                        }
                    }
                    return null;
                };
                
                // Prepara i record
                const records = jsonData.map(row => ({
                    mese: getCol(row, 'Mese', 'MESE') || null,
                    sku_origine: getCol(row, 'SKU ORIGINE', 'SKU') || null,
                    nome: getCol(row, 'NOME', 'Nome') || null,
                    sku_conversione: getCol(row, 'SKU CONVERSIONE') || null,
                    id_settore: getCol(row, 'ID SETTORE', 'SETTORE', 'Settore') || null,
                    nome_univoco: getCol(row, 'NOME UNIVOCO') || null,
                    categoria: getCol(row, 'Categoria', 'CATEGORIA') || null,
                    prezzo: parseFloat(getCol(row, 'Prezzo', 'PREZZO')) || null,
                    prezzo_medio: parseFloat(getCol(row, 'Prezzo medio', 'PREZZO MEDIO')) || null,
                    pezzi_venduti: parseFloat(getCol(row, 'Pezzi Venduti', 'PEZZI VENDUTI', 'Pezzi')) || null,
                    fatturato: parseFloat(getCol(row, 'FATTURATO', 'Fatturato')) || null,
                    gruppo_vendita_id: null
                })).filter(r => r.nome || r.nome_univoco);
                
                updateImportProgress(25, `Preparati ${records.length} record validi...`);
                
                // Assegna gruppo vendita automatico
                for (const record of records) {
                    if (record.categoria && MAPPING_CATEGORIA_GRUPPO[record.categoria]) {
                        const gruppoNome = MAPPING_CATEGORIA_GRUPPO[record.categoria];
                        const gruppo = allGruppiVendita.find(g => g.nome === gruppoNome);
                        if (gruppo) {
                            record.gruppo_vendita_id = gruppo.id;
                        }
                    }
                }
                
                // Insert in batch
                const BATCH_INSERT = 500;
                let inserted = 0;
                
                for (let i = 0; i < records.length; i += BATCH_INSERT) {
                    const batch = records.slice(i, i + BATCH_INSERT);
                    
                    const { error } = await supabaseClient
                        .from('vendite')
                        .insert(batch);
                    
                    if (error) throw error;
                    
                    inserted += batch.length;
                    updateImportProgress(25 + (inserted / records.length * 70), `Inserite ${inserted}/${records.length}...`);
                }
                
                updateImportProgress(100, 'Completato!');
                
                setTimeout(async () => {
                    closeImportModal();
                    await loadData();
                    alert(`‚úÖ Importate ${inserted} righe!`);
                }, 500);
                
            } catch (err) {
                console.error('Errore import:', err);
                alert('‚ùå Errore: ' + err.message);
            }
            
            event.target.value = '';
        }

        function updateImportProgress(percent, text) {
            document.getElementById('importProgressBar').style.width = percent + '%';
            document.getElementById('importProgressText').textContent = text;
        }

        // ===== INIT =====
        loadData();
        console.log('‚úÖ Vendite.html caricata');
    </script>
</body>
</html>