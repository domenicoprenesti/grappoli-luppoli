<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Date Database</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100 min-h-screen p-8">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-2xl shadow-xl p-8">
            <h1 class="text-2xl font-bold mb-6 flex items-center">
                <span class="mr-3">üîç</span>
                Debug Date Database
            </h1>
            
            <button onclick="verificaDate()" class="px-6 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 font-medium mb-6">
                Verifica Date nel Database
            </button>
            
            <div id="risultati" class="space-y-4"></div>
        </div>
    </div>

    <script>
        // Configurazione Supabase (dichiarata UNA SOLA VOLTA)
        const SUPABASE_URL = 'https://fqnzoxttbzzlgjxefelx.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZxbnpveHR0Ynp6bGdqeGVmZWx4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjczNzE4NTksImV4cCI6MjA4Mjk0Nzg1OX0.PLsZsBkac_Pjd8irfOXSwGlM5mg7B6X-5HRSQOfaFnk';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        async function verificaDate() {
            const risultatiDiv = document.getElementById('risultati');
            risultatiDiv.innerHTML = '<div class="text-blue-600">‚è≥ Caricamento in corso...</div>';
            
            try {
                // 1. Conta fatture totali
                const { count: totaleFatture, error: errCount } = await supabaseClient
                    .from('fatture')
                    .select('*', { count: 'exact', head: true });
                
                if (errCount) throw errCount;
                
                // 2. Carica un campione di fatture per analisi
                const { data: fatture, error: errFatture } = await supabaseClient
                    .from('fatture')
                    .select('id, numero_fattura, data_fattura, created_at')
                    .order('data_fattura', { ascending: false })
                    .limit(50);
                
                if (errFatture) throw errFatture;
                
                // 3. Analizza le date
                let dateValide = 0;
                let dateNulle = 0;
                let dateInvalide = 0;
                const problemi = [];
                
                fatture.forEach(f => {
                    if (!f.data_fattura) {
                        dateNulle++;
                        problemi.push({ id: f.id, numero: f.numero_fattura, problema: 'Data NULL' });
                    } else {
                        const data = new Date(f.data_fattura);
                        if (isNaN(data.getTime())) {
                            dateInvalide++;
                            problemi.push({ id: f.id, numero: f.numero_fattura, problema: `Data invalida: ${f.data_fattura}` });
                        } else {
                            dateValide++;
                        }
                    }
                });
                
                // 4. Carica prodotti per verificare collegamento
                const { count: totaleProdotti, error: errProdotti } = await supabaseClient
                    .from('prodotti')
                    .select('*', { count: 'exact', head: true });
                
                const { count: prodottiConFattura, error: errProdFatt } = await supabaseClient
                    .from('prodotti')
                    .select('*', { count: 'exact', head: true })
                    .not('fattura_id', 'is', null);
                
                // 5. Mostra risultati
                risultatiDiv.innerHTML = `
                    <div class="bg-blue-50 rounded-xl p-6 border-2 border-blue-200">
                        <h2 class="text-lg font-bold text-blue-900 mb-4">üìä Riepilogo Database</h2>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div class="bg-white p-4 rounded-lg">
                                <p class="text-sm text-gray-600">Fatture Totali</p>
                                <p class="text-3xl font-bold text-blue-600">${totaleFatture || 0}</p>
                            </div>
                            <div class="bg-white p-4 rounded-lg">
                                <p class="text-sm text-gray-600">Prodotti Totali</p>
                                <p class="text-3xl font-bold text-purple-600">${totaleProdotti || 0}</p>
                            </div>
                            <div class="bg-white p-4 rounded-lg">
                                <p class="text-sm text-gray-600">Prodotti con Fattura</p>
                                <p class="text-3xl font-bold text-green-600">${prodottiConFattura || 0}</p>
                            </div>
                            <div class="bg-white p-4 rounded-lg">
                                <p class="text-sm text-gray-600">Prodotti Orfani</p>
                                <p class="text-3xl font-bold text-orange-600">${(totaleProdotti || 0) - (prodottiConFattura || 0)}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-green-50 rounded-xl p-6 border-2 border-green-200">
                        <h2 class="text-lg font-bold text-green-900 mb-4">üìÖ Analisi Date (campione ${fatture.length} fatture)</h2>
                        <div class="grid md:grid-cols-3 gap-4">
                            <div class="bg-white p-4 rounded-lg text-center">
                                <p class="text-sm text-gray-600">Date Valide</p>
                                <p class="text-2xl font-bold text-green-600">${dateValide}</p>
                            </div>
                            <div class="bg-white p-4 rounded-lg text-center">
                                <p class="text-sm text-gray-600">Date NULL</p>
                                <p class="text-2xl font-bold text-yellow-600">${dateNulle}</p>
                            </div>
                            <div class="bg-white p-4 rounded-lg text-center">
                                <p class="text-sm text-gray-600">Date Invalide</p>
                                <p class="text-2xl font-bold text-red-600">${dateInvalide}</p>
                            </div>
                        </div>
                    </div>
                    
                    ${problemi.length > 0 ? `
                        <div class="bg-red-50 rounded-xl p-6 border-2 border-red-200">
                            <h2 class="text-lg font-bold text-red-900 mb-4">‚ö†Ô∏è Problemi Rilevati (${problemi.length})</h2>
                            <div class="max-h-60 overflow-auto">
                                <table class="w-full text-sm">
                                    <thead class="bg-red-100">
                                        <tr>
                                            <th class="px-3 py-2 text-left">ID</th>
                                            <th class="px-3 py-2 text-left">Numero</th>
                                            <th class="px-3 py-2 text-left">Problema</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${problemi.map(p => `
                                            <tr class="border-b border-red-100">
                                                <td class="px-3 py-2 font-mono text-xs">${p.id.substring(0, 8)}...</td>
                                                <td class="px-3 py-2">${p.numero || 'N/D'}</td>
                                                <td class="px-3 py-2 text-red-700">${p.problema}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    ` : `
                        <div class="bg-green-50 rounded-xl p-6 border-2 border-green-200 text-center">
                            <p class="text-green-700 font-medium">‚úÖ Nessun problema rilevato nelle date!</p>
                        </div>
                    `}
                    
                    <div class="bg-gray-50 rounded-xl p-6 border-2 border-gray-200">
                        <h2 class="text-lg font-bold text-gray-900 mb-4">üìã Ultime 10 Fatture</h2>
                        <div class="overflow-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="px-3 py-2 text-left">Numero</th>
                                        <th class="px-3 py-2 text-left">Data Fattura</th>
                                        <th class="px-3 py-2 text-left">Data Creazione</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${fatture.slice(0, 10).map(f => `
                                        <tr class="border-b">
                                            <td class="px-3 py-2 font-medium">${f.numero_fattura || 'N/D'}</td>
                                            <td class="px-3 py-2">${f.data_fattura ? new Date(f.data_fattura).toLocaleDateString('it-IT') : '‚ö†Ô∏è NULL'}</td>
                                            <td class="px-3 py-2 text-gray-500">${f.created_at ? new Date(f.created_at).toLocaleString('it-IT') : 'N/D'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                console.log('‚úÖ Verifica completata');
                console.log('Fatture totali:', totaleFatture);
                console.log('Prodotti totali:', totaleProdotti);
                console.log('Prodotti con fattura_id:', prodottiConFattura);
                
            } catch (err) {
                console.error('‚ùå Errore:', err);
                risultatiDiv.innerHTML = `
                    <div class="bg-red-50 rounded-xl p-6 border-2 border-red-200">
                        <h2 class="text-lg font-bold text-red-900 mb-2">‚ùå Errore</h2>
                        <p class="text-red-700">${err.message}</p>
                        <pre class="mt-4 text-xs bg-red-100 p-4 rounded overflow-auto">${JSON.stringify(err, null, 2)}</pre>
                    </div>
                `;
            }
        }
        
        console.log('‚úÖ Debug Date Database caricato');
    </script>
</body>
</html>