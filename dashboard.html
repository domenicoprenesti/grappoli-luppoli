<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grappoli & Luppoli - Dashboard Analitica</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100 min-h-screen">
    <script>
        // ========== REDIRECT SE NON AUTENTICATO ==========
        (function() {
            const SESSION_KEY = 'app_authenticated';
            const SESSION_DURATION = 24 * 60 * 60 * 1000;
            const auth = localStorage.getItem(SESSION_KEY);
            
            if (!auth) {
                window.location.href = 'index.html';
                return;
            }
            
            try {
                const authData = JSON.parse(auth);
                const now = new Date().getTime();
                if (now - authData.timestamp >= SESSION_DURATION) {
                    localStorage.removeItem(SESSION_KEY);
                    window.location.href = 'index.html';
                    return;
                }
            } catch (e) {
                localStorage.removeItem(SESSION_KEY);
                window.location.href = 'index.html';
                return;
            }
        })();
    </script>

    <!-- Navbar -->
    <nav class="fixed top-0 left-0 right-0 bg-white shadow-lg z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex items-center space-x-3">
                        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 p-2 rounded-lg">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                            </svg>
                        </div>
                        <span class="text-lg font-bold">Grappoli & Luppoli</span>
                    </div>
                    
                    <div class="hidden md:ml-10 md:flex md:space-x-4">
                        <a href="dashboard.html" class="px-3 py-2 rounded-md text-sm font-medium bg-blue-100 text-blue-700">Dashboard</a>
                        <a href="fatture.html" class="px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-100">Fatture</a>
                        <a href="prodotti.html" class="px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-100">Prodotti</a>
                        <a href="fornitori.html" class="px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-100">Fornitori</a>
                        <a href="utenti.html" class="px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-100">Utenti</a>
                    </div>
                </div>
                
                <div class="flex items-center space-x-3">
                    <span id="userName" class="text-sm text-gray-600"></span>
                    <button onclick="logout()" class="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200">Esci</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-24 pb-8">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">üìä Dashboard Analitica</h1>
            <p class="mt-2 text-gray-600">Panoramica e storico dei costi basato sui dati reali</p>
        </div>

        <!-- Loading -->
        <div id="loadingDiv" class="bg-white rounded-xl shadow-lg p-8 mb-8">
            <div class="flex items-center justify-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mr-3"></div>
                <span class="text-gray-600">Caricamento dati da Supabase...</span>
            </div>
        </div>

        <!-- FILTRI -->
        <div id="filtriSection" class="hidden bg-white rounded-xl shadow-lg p-6 mb-8">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-bold text-gray-900 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                    </svg>
                    Filtri Analisi
                </h2>
                <div id="filtriAttivi" class="hidden">
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span id="filtriAttiviText">Filtri attivi</span>
                    </span>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <!-- Filtro Anno -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">üìÖ Anno</label>
                    <select id="filterAnno" onchange="applyFilters()" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Tutti gli anni</option>
                    </select>
                </div>
                
                <!-- Filtro Mese -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">üóìÔ∏è Mese</label>
                    <select id="filterMese" onchange="applyFilters()" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Tutti i mesi</option>
                        <option value="1">Gennaio</option>
                        <option value="2">Febbraio</option>
                        <option value="3">Marzo</option>
                        <option value="4">Aprile</option>
                        <option value="5">Maggio</option>
                        <option value="6">Giugno</option>
                        <option value="7">Luglio</option>
                        <option value="8">Agosto</option>
                        <option value="9">Settembre</option>
                        <option value="10">Ottobre</option>
                        <option value="11">Novembre</option>
                        <option value="12">Dicembre</option>
                    </select>
                </div>
                
                <!-- Filtro Categoria -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">üè∑Ô∏è Categoria</label>
                    <select id="filterCategoria" onchange="applyFilters()" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Tutte le categorie</option>
                    </select>
                </div>
                
                <!-- Pulsante Reset -->
                <div class="flex items-end">
                    <button onclick="resetFilters()" class="w-full px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium flex items-center justify-center space-x-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        <span>Reset Filtri</span>
                    </button>
                </div>
            </div>
            
            <!-- Riepilogo Periodo Selezionato -->
            <div id="periodoSelezionato" class="hidden mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                <p class="text-sm text-blue-800">
                    <strong>Periodo selezionato:</strong> <span id="periodoText">Tutti i dati</span>
                </p>
            </div>
        </div>

        <!-- Stats Cards -->
        <div id="statsCards" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Fatture Totali -->
            <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-blue-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Fatture Totali</p>
                        <p id="statFatture" class="text-2xl font-bold text-gray-900 mt-2">0</p>
                    </div>
                    <div class="bg-blue-100 p-3 rounded-lg">
                        <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Prodotti Totali -->
            <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-purple-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Prodotti Filtrati</p>
                        <p id="statProdotti" class="text-2xl font-bold text-gray-900 mt-2">0</p>
                    </div>
                    <div class="bg-purple-100 p-3 rounded-lg">
                        <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Costo Totale (con IVA) -->
            <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-red-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Costo Totale (IVA incl.)</p>
                        <p id="statCostoTotale" class="text-2xl font-bold text-red-600 mt-2">‚Ç¨0</p>
                    </div>
                    <div class="bg-red-100 p-3 rounded-lg">
                        <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Media Mensile -->
            <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-green-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Media Mensile</p>
                        <p id="statMediaMensile" class="text-2xl font-bold text-green-600 mt-2">‚Ç¨0</p>
                    </div>
                    <div class="bg-green-100 p-3 rounded-lg">
                        <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div id="chartsRow" class="hidden grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Grafico Storico Mensile -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-bold text-gray-900 mb-4">üìà Storico Costi Mensili</h2>
                <div class="h-80">
                    <canvas id="chartMensile"></canvas>
                </div>
            </div>

            <!-- Grafico per Categoria / Tipo -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 id="chartCategorieTitle" class="text-xl font-bold text-gray-900 mb-4">üè∑Ô∏è Distribuzione per Categoria</h2>
                <div class="h-80">
                    <canvas id="chartCategorie"></canvas>
                </div>
            </div>
        </div>

        <!-- Dettaglio Mensile -->
        <div id="dettaglioMensile" class="hidden bg-white rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-900 mb-4">üìÖ Dettaglio per Mese</h2>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-semibold">Mese</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold">Prodotti</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold">Quantit√†</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold">Costo (senza IVA)</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold">Costo (con IVA)</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold">Œî vs Prec.</th>
                        </tr>
                    </thead>
                    <tbody id="tabellaDettaglioMensile" class="divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>

        <!-- Top Categorie -->
        <div id="topCategorie" class="hidden bg-white rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-900 mb-4">üèÜ Top Categorie per Spesa</h2>
            <div id="categorieCards" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4"></div>
        </div>

        <!-- Quick Actions -->
        <div id="quickActions" class="hidden grid grid-cols-1 md:grid-cols-3 gap-6">
            <a href="fatture.html" class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-xl p-6 text-white hover:scale-105 transition-transform">
                <svg class="w-12 h-12 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <h3 class="text-xl font-bold mb-2">Gestione Fatture</h3>
                <p class="text-blue-100 text-sm">Carica e visualizza fatture XML</p>
            </a>

            <a href="prodotti.html" class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl shadow-xl p-6 text-white hover:scale-105 transition-transform">
                <svg class="w-12 h-12 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                </svg>
                <h3 class="text-xl font-bold mb-2">Analisi Prodotti</h3>
                <p class="text-purple-100 text-sm">Esplora prodotti e categorie</p>
            </a>

            <a href="fornitori.html" class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl shadow-xl p-6 text-white hover:scale-105 transition-transform">
                <svg class="w-12 h-12 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                </svg>
                <h3 class="text-xl font-bold mb-2">Gestione Fornitori</h3>
                <p class="text-green-100 text-sm">Anagrafica e condizioni</p>
            </a>
        </div>
    </div>

    <script>
        // ========== CONFIGURAZIONE SUPABASE ==========
        const SUPABASE_URL = 'https://fqnzoxttbzzlgjxefelx.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZxbnpveHR0Ynp6bGdqeGVmZWx4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjczNzE4NTksImV4cCI6MjA4Mjk0Nzg1OX0.PLsZsBkac_Pjd8irfOXSwGlM5mg7B6X-5HRSQOfaFnk';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const SESSION_KEY = 'app_authenticated';
        const BATCH_SIZE = 1000;

        // ========== STATO ==========
        let allProdottiOriginal = []; // Dati originali non filtrati
        let allFattureOriginal = [];  // Fatture originali
        
        let dashboardData = {
            fatture: { count: 0, totale: 0 },
            prodotti: { count: 0, costoTotale: 0, costoIvato: 0 },
            storicoMensile: [],
            categorie: []
        };

        // Istanze grafici per poterli distruggere e ricreare
        let chartMensileInstance = null;
        let chartCategorieInstance = null;

        // ========== FUNZIONI UTILIT√Ä ==========
        function logout() {
            localStorage.removeItem(SESSION_KEY);
            window.location.href = 'index.html';
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('it-IT', {
                style: 'currency',
                currency: 'EUR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value || 0);
        }

        function getMonthName(month) {
            const months = ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu', 'Lug', 'Ago', 'Set', 'Ott', 'Nov', 'Dic'];
            return months[month - 1] || '';
        }
        
        function getMonthNameFull(month) {
            const months = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
            return months[month - 1] || '';
        }

        // ========== POPOLAMENTO FILTRI ==========
        function populateFilters() {
            // Estrai anni unici dai prodotti
            const anniSet = new Set();
            const categorieSet = new Set();
            
            allProdottiOriginal.forEach(p => {
                if (p.data_fattura) {
                    const date = new Date(p.data_fattura);
                    anniSet.add(date.getFullYear());
                }
                const nomeCategoria = p.tipo_prodotto?.aggregante_prodotto?.nome || p.categoria;
                if (nomeCategoria) {
                    categorieSet.add(nomeCategoria);
                }
            });
            
            // Popola select anni (ordinati decrescente)
            const anniArray = Array.from(anniSet).sort((a, b) => b - a);
            const selectAnno = document.getElementById('filterAnno');
            selectAnno.innerHTML = '<option value="">Tutti gli anni</option>';
            anniArray.forEach(anno => {
                selectAnno.innerHTML += `<option value="${anno}">${anno}</option>`;
            });
            
            // Popola select categorie (ordinate alfabeticamente)
            const categorieArray = Array.from(categorieSet).sort();
            const selectCategoria = document.getElementById('filterCategoria');
            selectCategoria.innerHTML = '<option value="">Tutte le categorie</option>';
            categorieArray.forEach(cat => {
                selectCategoria.innerHTML += `<option value="${cat}">${cat}</option>`;
            });
        }

        // ========== APPLICAZIONE FILTRI ==========
        function applyFilters() {
            const filterAnno = document.getElementById('filterAnno').value;
            const filterMese = document.getElementById('filterMese').value;
            const filterCategoria = document.getElementById('filterCategoria').value;
            
            // Filtra i prodotti
            let prodottiFiltrati = allProdottiOriginal.filter(p => {
                // Filtro anno
                if (filterAnno && p.data_fattura) {
                    const anno = new Date(p.data_fattura).getFullYear();
                    if (anno !== parseInt(filterAnno)) return false;
                } else if (filterAnno && !p.data_fattura) {
                    return false;
                }
                
                // Filtro mese
                if (filterMese && p.data_fattura) {
                    const mese = new Date(p.data_fattura).getMonth() + 1;
                    if (mese !== parseInt(filterMese)) return false;
                } else if (filterMese && !p.data_fattura) {
                    return false;
                }
                
                // Filtro categoria
                if (filterCategoria) {
                    const nomeCategoria = p.tipo_prodotto?.aggregante_prodotto?.nome || p.categoria;
                    if (nomeCategoria !== filterCategoria) return false;
                }
                
                return true;
            });
            
            // Aggiorna indicatore filtri attivi
            updateFilterIndicator(filterAnno, filterMese, filterCategoria);
            
            // Ricalcola i dati della dashboard con i prodotti filtrati
            recalculateDashboardData(prodottiFiltrati, filterAnno, filterMese);
            
            // Ri-renderizza
            renderDashboard();
        }

        function updateFilterIndicator(anno, mese, categoria) {
            const filtriAttivi = document.getElementById('filtriAttivi');
            const filtriAttiviText = document.getElementById('filtriAttiviText');
            const periodoDiv = document.getElementById('periodoSelezionato');
            const periodoText = document.getElementById('periodoText');
            
            const filtriApplicati = [];
            if (anno) filtriApplicati.push(`Anno: ${anno}`);
            if (mese) filtriApplicati.push(`Mese: ${getMonthNameFull(parseInt(mese))}`);
            if (categoria) filtriApplicati.push(`Cat: ${categoria}`);
            
            if (filtriApplicati.length > 0) {
                filtriAttivi.classList.remove('hidden');
                filtriAttiviText.textContent = `${filtriApplicati.length} filtri attivi`;
                
                periodoDiv.classList.remove('hidden');
                periodoText.textContent = filtriApplicati.join(' | ');
            } else {
                filtriAttivi.classList.add('hidden');
                periodoDiv.classList.add('hidden');
            }
        }

        function resetFilters() {
            document.getElementById('filterAnno').value = '';
            document.getElementById('filterMese').value = '';
            document.getElementById('filterCategoria').value = '';
            applyFilters();
        }

        // ========== RICALCOLO DATI ==========
        function recalculateDashboardData(prodottiFiltrati, filterAnno, filterMese) {
            // Conta prodotti filtrati
            dashboardData.prodotti.count = prodottiFiltrati.length;
            
            // Calcola costi totali
            dashboardData.prodotti.costoTotale = prodottiFiltrati.reduce((s, p) => {
                const prezzo = p.prezzo_scontato || p.prezzo || 0;
                return s + (prezzo * (p.quantita || 0));
            }, 0);

            dashboardData.prodotti.costoIvato = prodottiFiltrati.reduce((s, p) => {
                return s + ((p.prezzo_ivato || 0) * (p.quantita || 0));
            }, 0);

            // Raggruppa per mese
            const byMonth = {};
            prodottiFiltrati.forEach(p => {
                if (!p.data_fattura) return;
                
                const date = new Date(p.data_fattura);
                const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                
                if (!byMonth[key]) {
                    byMonth[key] = {
                        anno: date.getFullYear(),
                        mese: date.getMonth() + 1,
                        numProdotti: 0,
                        quantita: 0,
                        costoSenzaIva: 0,
                        costoConIva: 0
                    };
                }
                
                byMonth[key].numProdotti++;
                byMonth[key].quantita += p.quantita || 0;
                byMonth[key].costoSenzaIva += (p.prezzo_scontato || p.prezzo || 0) * (p.quantita || 0);
                byMonth[key].costoConIva += (p.prezzo_ivato || 0) * (p.quantita || 0);
            });

            dashboardData.storicoMensile = Object.values(byMonth).sort((a, b) => {
                if (a.anno !== b.anno) return a.anno - b.anno;
                return a.mese - b.mese;
            });

            // Raggruppa per categoria
            const byCategoria = {};
            prodottiFiltrati.forEach(p => {
                const cat = p.tipo_prodotto?.aggregante_prodotto?.nome || p.categoria || 'Non categorizzato';
                if (!byCategoria[cat]) {
                    byCategoria[cat] = { nome: cat, numProdotti: 0, costoIvato: 0 };
                }
                byCategoria[cat].numProdotti++;
                byCategoria[cat].costoIvato += (p.prezzo_ivato || 0) * (p.quantita || 0);
            });

            dashboardData.categorie = Object.values(byCategoria).sort((a, b) => b.costoIvato - a.costoIvato);
            
            // Raggruppa per TIPO (usato quando filtro categoria √® attivo)
            const byTipo = {};
            prodottiFiltrati.forEach(p => {
                const tipo = p.tipo_prodotto?.nome || 'Senza tipo';
                if (!byTipo[tipo]) {
                    byTipo[tipo] = { nome: tipo, numProdotti: 0, costoIvato: 0 };
                }
                byTipo[tipo].numProdotti++;
                byTipo[tipo].costoIvato += (p.prezzo_ivato || 0) * (p.quantita || 0);
            });
            
            dashboardData.tipi = Object.values(byTipo).sort((a, b) => b.costoIvato - a.costoIvato);
            
            // Conta fatture (se filtrate per periodo)
            if (filterAnno || filterMese) {
                const fattureIdsSet = new Set();
                prodottiFiltrati.forEach(p => {
                    if (p.fattura_id) fattureIdsSet.add(p.fattura_id);
                });
                dashboardData.fatture.count = fattureIdsSet.size;
            } else {
                dashboardData.fatture.count = allFattureOriginal.length;
            }
        }

        // ========== CARICAMENTO DATI ==========
        async function loadDashboardData() {
            try {
                console.log('üìä Caricamento dati dashboard...');

                // 1. Conta e carica fatture
                const { count: fattureCount } = await supabaseClient
                    .from('fatture')
                    .select('*', { count: 'exact', head: true });
                
                dashboardData.fatture.count = fattureCount || 0;

                // Carica IDs fatture per riferimento
                const { data: fattureIds } = await supabaseClient
                    .from('fatture')
                    .select('id, importo_totale');
                
                allFattureOriginal = fattureIds || [];
                dashboardData.fatture.totale = allFattureOriginal.reduce((s, f) => s + (f.importo_totale || 0), 0);

                // 2. Conta prodotti
                const { count: prodottiCount } = await supabaseClient
                    .from('prodotti')
                    .select('*', { count: 'exact', head: true });
                
                dashboardData.prodotti.count = prodottiCount || 0;

                // 3. Carica tutti i prodotti (in batch)
                allProdottiOriginal = [];
                const numBatches = Math.ceil(prodottiCount / BATCH_SIZE);
                
                for (let i = 0; i < numBatches; i++) {
                    const { data } = await supabaseClient
                        .from('prodotti')
                        .select(`
                            fattura_id, 
                            data_fattura, 
                            categoria, 
                            prezzo_scontato, 
                            prezzo, 
                            prezzo_ivato, 
                            quantita,
                            tipo_prodotto (
                                id,
                                nome,
                                aggregante_prodotto (
                                    id,
                                    nome,
                                    colore
                                )
                            )
                        `)
                        .range(i * BATCH_SIZE, (i + 1) * BATCH_SIZE - 1);
                    
                    if (data) allProdottiOriginal = [...allProdottiOriginal, ...data];
                }

                console.log(`‚úÖ Caricati ${allProdottiOriginal.length} prodotti`);

                // 4. Popola i filtri con i valori disponibili
                populateFilters();

                // 5. Calcola dati iniziali (senza filtri)
                recalculateDashboardData(allProdottiOriginal, '', '');

                console.log('‚úÖ Dati dashboard elaborati');
                
                // Mostra sezione filtri
                document.getElementById('filtriSection').classList.remove('hidden');
                
                renderDashboard();

            } catch (err) {
                console.error('‚ùå Errore caricamento dashboard:', err);
                document.getElementById('loadingDiv').innerHTML = `
                    <div class="text-center text-red-600">
                        <p class="font-bold">Errore nel caricamento</p>
                        <p class="text-sm">${err.message}</p>
                    </div>
                `;
            }
        }

        // ========== RENDER ==========
        function renderDashboard() {
            // Nascondi loading, mostra contenuto
            document.getElementById('loadingDiv').classList.add('hidden');
            document.getElementById('statsCards').classList.remove('hidden');
            document.getElementById('chartsRow').classList.remove('hidden');
            document.getElementById('dettaglioMensile').classList.remove('hidden');
            document.getElementById('topCategorie').classList.remove('hidden');
            document.getElementById('quickActions').classList.remove('hidden');

            // Aggiorna stats cards
            document.getElementById('statFatture').textContent = dashboardData.fatture.count.toLocaleString('it-IT');
            document.getElementById('statProdotti').textContent = dashboardData.prodotti.count.toLocaleString('it-IT');
            document.getElementById('statCostoTotale').textContent = formatCurrency(dashboardData.prodotti.costoIvato);
            
            const numMesi = dashboardData.storicoMensile.length || 1;
            const mediaMensile = dashboardData.prodotti.costoIvato / numMesi;
            document.getElementById('statMediaMensile').textContent = formatCurrency(mediaMensile);

            // Mostra nome utente
            const auth = JSON.parse(localStorage.getItem(SESSION_KEY) || '{}');
            document.getElementById('userName').textContent = `Ciao, ${auth.userName || 'Utente'}`;

            // Render grafici
            renderChartMensile();
            renderChartCategorie();
            renderTabellaDettaglio();
            renderCategorieCards();
        }

        // ========== GRAFICO MENSILE (Multi-Anno) ==========
        function renderChartMensile() {
            // Distruggi grafico precedente se esiste
            if (chartMensileInstance) {
                chartMensileInstance.destroy();
            }
            
            const ctx = document.getElementById('chartMensile').getContext('2d');
            
            // Labels fissi: 12 mesi
            const labels = ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu', 'Lug', 'Ago', 'Set', 'Ott', 'Nov', 'Dic'];
            
            // Estrai anni unici dai dati
            const anniUnici = [...new Set(dashboardData.storicoMensile.map(m => m.anno))].sort();
            
            // Palette colori per gli anni
            const colori = [
                { border: '#6366F1', bg: 'rgba(99, 102, 241, 0.15)' },   // Indigo
                { border: '#EF4444', bg: 'rgba(239, 68, 68, 0.15)' },    // Red
                { border: '#10B981', bg: 'rgba(16, 185, 129, 0.15)' },   // Emerald
                { border: '#F59E0B', bg: 'rgba(245, 158, 11, 0.15)' },   // Amber
                { border: '#8B5CF6', bg: 'rgba(139, 92, 246, 0.15)' },   // Violet
                { border: '#EC4899', bg: 'rgba(236, 72, 153, 0.15)' },   // Pink
                { border: '#06B6D4', bg: 'rgba(6, 182, 212, 0.15)' },    // Cyan
                { border: '#84CC16', bg: 'rgba(132, 204, 22, 0.15)' }    // Lime
            ];
            
            // Crea un dataset per ogni anno
            const datasets = anniUnici.map((anno, idx) => {
                // Crea array di 12 elementi (uno per mese), inizializzato a null
                const dataPerMese = new Array(12).fill(null);
                
                // Popola con i dati disponibili per quell'anno
                dashboardData.storicoMensile
                    .filter(m => m.anno === anno)
                    .forEach(m => {
                        dataPerMese[m.mese - 1] = m.costoConIva; // mese 1 = indice 0
                    });
                
                // Calcola totale annuo
                const totaleAnno = dataPerMese.reduce((sum, val) => sum + (val || 0), 0);
                const totaleFormattato = totaleAnno >= 1000 
                    ? '‚Ç¨' + (totaleAnno / 1000).toFixed(1) + 'k' 
                    : '‚Ç¨' + totaleAnno.toFixed(0);
                
                const colore = colori[idx % colori.length];
                
                return {
                    label: `${anno} (${totaleFormattato})`,
                    data: dataPerMese,
                    borderColor: colore.border,
                    backgroundColor: colore.bg,
                    fill: false,
                    tension: 0.3,
                    borderWidth: 2.5,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    pointBackgroundColor: colore.border,
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    spanGaps: true // Connette i punti anche se ci sono null in mezzo
                };
            });

            chartMensileInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: { 
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: { weight: 'bold' }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (context.raw === null) return null;
                                    // Estrai solo l'anno dalla label (rimuovi il totale tra parentesi)
                                    const anno = context.dataset.label.split(' ')[0];
                                    return anno + ': ' + formatCurrency(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                font: { weight: 'bold' }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.08)'
                            },
                            ticks: {
                                font: { weight: '500' },
                                callback: function(value) {
                                    if (value >= 1000) {
                                        return '‚Ç¨' + (value / 1000).toFixed(0) + 'k';
                                    }
                                    return '‚Ç¨' + value;
                                }
                            }
                        }
                    }
                }
            });
        }

        // ========== GRAFICO CATEGORIE / TIPI ==========
        function renderChartCategorie() {
            // Distruggi grafico precedente se esiste
            if (chartCategorieInstance) {
                chartCategorieInstance.destroy();
            }
            
            const ctx = document.getElementById('chartCategorie').getContext('2d');
            const titleElement = document.getElementById('chartCategorieTitle');
            
            // Verifica se il filtro categoria √® attivo
            const filterCategoria = document.getElementById('filterCategoria').value;
            
            // Se filtro categoria attivo -> mostra distribuzione per TIPO
            // Altrimenti -> mostra distribuzione per CATEGORIA
            const useTipi = filterCategoria && filterCategoria !== '';
            const dataSource = useTipi ? (dashboardData.tipi || []) : dashboardData.categorie;
            
            // Aggiorna titolo del grafico
            if (titleElement) {
                if (useTipi) {
                    titleElement.textContent = `üì¶ Distribuzione per Tipo (${filterCategoria})`;
                } else {
                    titleElement.textContent = 'üè∑Ô∏è Distribuzione per Categoria';
                }
            }
            
            const colors = [
                '#3B82F6', '#8B5CF6', '#EC4899', '#F59E0B', 
                '#10B981', '#6366F1', '#EF4444', '#06B6D4',
                '#84CC16', '#F97316', '#14B8A6', '#A855F7'
            ];

            chartCategorieInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: dataSource.map(c => c.nome),
                    datasets: [{
                        data: dataSource.map(c => c.costoIvato),
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: 'right',
                            labels: {
                                boxWidth: 12,
                                font: { size: 11 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.raw / total) * 100).toFixed(1);
                                    return `${context.label}: ${formatCurrency(context.raw)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // ========== TABELLA DETTAGLIO ==========
        function renderTabellaDettaglio() {
            const tbody = document.getElementById('tabellaDettaglioMensile');
            
            if (dashboardData.storicoMensile.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                            Nessun dato disponibile per i filtri selezionati
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Ordina dal pi√π recente
            const storicoReversed = [...dashboardData.storicoMensile].reverse();

            tbody.innerHTML = storicoReversed.map((m, idx) => {
                // Calcola delta vs mese precedente
                const prev = storicoReversed[idx + 1];
                let delta = 0;
                let deltaClass = 'text-gray-500';
                let deltaIcon = '';
                
                if (prev) {
                    delta = ((m.costoConIva - prev.costoConIva) / prev.costoConIva * 100);
                    if (delta > 0) {
                        deltaClass = 'text-red-600';
                        deltaIcon = '‚Üë';
                    } else if (delta < 0) {
                        deltaClass = 'text-green-600';
                        deltaIcon = '‚Üì';
                    }
                }

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 font-medium">${getMonthName(m.mese)} ${m.anno}</td>
                        <td class="px-4 py-3 text-right">${m.numProdotti.toLocaleString('it-IT')}</td>
                        <td class="px-4 py-3 text-right">${m.quantita.toLocaleString('it-IT', { maximumFractionDigits: 0 })}</td>
                        <td class="px-4 py-3 text-right">${formatCurrency(m.costoSenzaIva)}</td>
                        <td class="px-4 py-3 text-right font-bold">${formatCurrency(m.costoConIva)}</td>
                        <td class="px-4 py-3 text-right ${deltaClass} font-medium">
                            ${prev ? `${deltaIcon} ${Math.abs(delta).toFixed(1)}%` : '-'}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ========== CATEGORIE CARDS ==========
        function renderCategorieCards() {
            const container = document.getElementById('categorieCards');
            const colors = [
                'from-blue-500 to-blue-600',
                'from-purple-500 to-purple-600',
                'from-pink-500 to-pink-600',
                'from-amber-500 to-amber-600',
                'from-emerald-500 to-emerald-600',
                'from-indigo-500 to-indigo-600'
            ];

            if (dashboardData.categorie.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center text-gray-500 py-4">
                        Nessuna categoria disponibile per i filtri selezionati
                    </div>
                `;
                return;
            }

            container.innerHTML = dashboardData.categorie.slice(0, 6).map((cat, idx) => {
                const total = dashboardData.prodotti.costoIvato;
                const percentage = total > 0 ? ((cat.costoIvato / total) * 100).toFixed(1) : 0;
                
                return `
                    <div class="bg-gradient-to-br ${colors[idx % colors.length]} rounded-xl p-4 text-white">
                        <p class="text-xs opacity-80 truncate" title="${cat.nome}">${cat.nome}</p>
                        <p class="text-xl font-bold">${formatCurrency(cat.costoIvato)}</p>
                        <p class="text-xs opacity-80">${percentage}% del totale</p>
                        <p class="text-xs opacity-60 mt-1">${cat.numProdotti} prodotti</p>
                    </div>
                `;
            }).join('');
        }

        // ========== INIZIALIZZAZIONE ==========
        loadDashboardData();
        console.log('‚úÖ Dashboard Analitica con Filtri caricata');
    </script>
</body>
</html>